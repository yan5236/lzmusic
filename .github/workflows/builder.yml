# GitHub Actions å·¥ä½œæµï¼šè‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ LZ Music
# 
# åŠŸèƒ½è¯´æ˜ï¼š
# 1. æ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆWindowsã€Linuxã€macOSï¼‰
# 2. è‡ªåŠ¨å‘å¸ƒï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è‡ªåŠ¨åˆ›å»ºGitHub Release
# 3. æ‰‹åŠ¨å‘å¸ƒï¼šå¯åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è§¦å‘
# 4. æ„å»ºäº§ç‰©ï¼šWindowså®‰è£…ç‰ˆ+è§£å‹ç‰ˆã€Linuxå¤šæ ¼å¼ã€macOS DMG
#
# è§¦å‘æ¡ä»¶ï¼š
# - æ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰
# - æ¨é€ beta ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ 1.0.0-betaï¼‰
# - æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
name: Build and Release

# å·¥ä½œæµè§¦å‘æ¡ä»¶
on:
  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'           # æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
      - '*.*.*-beta'   # Betaç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ 1.0.0-beta
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºå‘è¡Œç‰ˆ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      upload_to_release:
        description: 'æ˜¯å¦ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°å‘è¡Œç‰ˆ'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.0.0)'
        required: false
        type: string

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  FORCE_COLOR: true  # å¯ç”¨å½©è‰²è¾“å‡º

jobs:
  # æ„å»ºä»»åŠ¡ï¼šåœ¨å¤šä¸ªå¹³å°ä¸Šå¹¶è¡Œæ„å»ºåº”ç”¨
  build:
    runs-on: ${{ matrix.os }}
    
    # æ„å»ºçŸ©é˜µï¼šå®šä¹‰ä¸åŒå¹³å°çš„æ„å»ºç¯å¢ƒ
    strategy:
      fail-fast: false  # ä¸å› ä¸ºä¸€ä¸ªå¹³å°å¤±è´¥è€Œå–æ¶ˆå…¶ä»–å¹³å°çš„æ„å»º
      matrix:
        include:
          # Windows æ„å»ºç¯å¢ƒ
          - os: windows-latest
            platform: win32
            arch: x64
            npm_config_cache: ~/.npm
          # Linux æ„å»ºç¯å¢ƒ
          - os: ubuntu-latest
            platform: linux
            arch: x64
            npm_config_cache: ~/.npm
          # macOS æ„å»ºç¯å¢ƒ (æš‚æ—¶ç¦ç”¨ï¼Œå› ä¸ºå¯èƒ½éœ€è¦ä»˜è´¹å¼€å‘è€…è´¦æˆ·)
          # - os: macos-latest
          #   platform: darwin
          #   arch: x64
          #   npm_config_cache: ~/.npm

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºæºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # ä½¿ç”¨ Node.js 18
          cache: 'npm'           # å¯ç”¨ npm ç¼“å­˜

      # æ­¥éª¤3ï¼šé…ç½® npm ç¼“å­˜ä»¥åŠ é€Ÿæ„å»º
      - name: é…ç½® npm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ matrix.npm_config_cache }}
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # æ­¥éª¤4ï¼šå®‰è£…é¡¹ç›®ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # æ­¥éª¤5ï¼šæ„å»º Windows åº”ç”¨
      # ç”Ÿæˆå®‰è£…ç‰ˆ(.exe)å’Œè§£å‹ç‰ˆ(.zip)
      - name: æ„å»ºåº”ç”¨ (Windows)
        if: matrix.platform == 'win32'
        run: |
          echo "å¼€å§‹æ„å»ºWindowsåº”ç”¨..."
          npm run build-win
          echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•..."
          dir dist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤6ï¼šæ„å»º Linux åº”ç”¨
      # ç”Ÿæˆ AppImageã€debã€rpm æ ¼å¼
      - name: æ„å»ºåº”ç”¨ (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "å¼€å§‹æ„å»ºLinuxåº”ç”¨..."
          echo "å½“å‰package.jsonä½œè€…ä¿¡æ¯:"
          cat package.json | grep -A 3 '"author"'
          npm run build-linux
          echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•..."
          ls -la dist/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤7ï¼šæ„å»º macOS åº”ç”¨ (æš‚æ—¶ç¦ç”¨)
      # ç”Ÿæˆ DMG å®‰è£…åŒ…
      # - name: æ„å»ºåº”ç”¨ (macOS)
      #   if: matrix.platform == 'darwin'
      #   run: |
      #     npx electron-builder --mac --x64
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤8ï¼šä¸Šä¼  Windows æ„å»ºäº§ç‰©
      # åŒ…å«å®‰è£…ç‰ˆå’Œè§£å‹ç‰ˆ
      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Windows)
        if: matrix.platform == 'win32'
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            dist/*.exe
            dist/*.zip
          retention-days: 30
          if-no-files-found: warn

      # æ­¥éª¤9ï¼šä¸Šä¼  Linux æ„å»ºäº§ç‰©
      # åŒ…å«å¤šç§ Linux å‘è¡Œç‰ˆæ ¼å¼
      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Linux)
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.tar.gz
          retention-days: 30
          if-no-files-found: warn

      # æ­¥éª¤10ï¼šä¸Šä¼  macOS æ„å»ºäº§ç‰© (æš‚æ—¶ç¦ç”¨)
      # - name: ä¸Šä¼ æ„å»ºäº§ç‰© (macOS)
      #   if: matrix.platform == 'darwin'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: macos-builds
      #     path: |
      #       dist/*.dmg    # macOS å®‰è£…åŒ…
      #       dist/*.zip    # macOS å‹ç¼©åŒ…
      #     retention-days: 30

  # å‘å¸ƒä»»åŠ¡ï¼šåˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ„å»ºäº§ç‰©
  release:
    needs: build  # ä¾èµ–æ„å»ºä»»åŠ¡å®Œæˆ
    runs-on: ubuntu-latest
    # å‘å¸ƒæ¡ä»¶ï¼šæ¨é€æ ‡ç­¾æˆ–æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©åˆ›å»ºå‘è¡Œç‰ˆ
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ï¼ˆç”¨äºè·å–ç‰ˆæœ¬ä¿¡æ¯ï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šä¸‹è½½æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©ï¼ˆä»…åœ¨éœ€è¦ä¸Šä¼ æ—¶ä¸‹è½½ï¼‰
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        if: |
          github.event_name == 'push' || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')
        uses: actions/download-artifact@v4

      # æ­¥éª¤3ï¼šè·å–ç‰ˆæœ¬ä¿¡æ¯
      # ä»æ ‡ç­¾æˆ–æ‰‹åŠ¨è¾“å…¥ä¸­æå–ç‰ˆæœ¬å·
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="${{ github.event.inputs.version_tag }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # æ­¥éª¤4ï¼šåˆ›å»º GitHub Release
      # è‡ªåŠ¨ç”Ÿæˆå‘è¡Œè¯´æ˜å¹¶ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: åˆ›å»ºå‘è¡Œç‰ˆ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: LZ Music ${{ steps.version.outputs.version }}
          body: |
            ## ğŸµ LZ Music ${{ steps.version.outputs.version }}
            
            åŸºäº Bilibili API çš„éŸ³ä¹æ’­æ”¾å™¨æ–°ç‰ˆæœ¬å‘å¸ƒï¼
            
            ### ğŸ“¦ ä¸‹è½½
            
            **Windows:**
            - ğŸ”§ å®‰è£…ç‰ˆ: `LZ-Music-*-Setup.exe` - æ¨èï¼ŒåŒ…å«è‡ªåŠ¨æ›´æ–°
            - ğŸ“ è§£å‹ç‰ˆ: `LZ-Music-*-win32-x64.zip` - ç»¿è‰²ç‰ˆï¼Œè§£å‹å³ç”¨
            
            **Linux:**
            - ğŸ§ AppImage: `LZ-Music-*.AppImage` - é€šç”¨æ ¼å¼ï¼Œé€‚ç”¨äºæ‰€æœ‰å‘è¡Œç‰ˆ
            - ğŸ“¦ DebianåŒ…: `LZ-Music-*.deb` - é€‚ç”¨äº Ubuntu/Debian
            - ğŸ“¦ RPMåŒ…: `LZ-Music-*.rpm` - é€‚ç”¨äº CentOS/Fedora
            
            **macOS:**
            - ğŸ DMGå®‰è£…åŒ…: `LZ-Music-*.dmg` - æ ‡å‡† macOS å®‰è£…åŒ…
            
            ### ğŸ”§ å®‰è£…è¯´æ˜
            
            - **Windows**: 
              - å®‰è£…ç‰ˆï¼šä¸‹è½½ Setup.exe æ–‡ä»¶ç›´æ¥è¿è¡Œå®‰è£…
              - è§£å‹ç‰ˆï¼šä¸‹è½½ zip æ–‡ä»¶ï¼Œè§£å‹åè¿è¡Œ LZ Music.exe
            - **Linux**: 
              - AppImageï¼šä¸‹è½½åæ·»åŠ æ‰§è¡Œæƒé™ `chmod +x *.AppImage`ï¼ŒåŒå‡»è¿è¡Œ
              - deb/rpmï¼šä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…
            
            ### âœ¨ ä¸»è¦åŠŸèƒ½
            
            - ğŸµ éŸ³ä¹é¦–é¡µæ¨è
            - ğŸ” æ™ºèƒ½æœç´¢
            - ğŸ“± ç°ä»£ç•Œé¢
            - ğŸ§ å®Œæ•´æ’­æ”¾æ§åˆ¶
            - ğŸ“ æ’­æ”¾å†å²è®°å½•
            - ğŸ”„ å¤šç§æ’­æ”¾æ¨¡å¼
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ”¹ã€‚
            
          draft: false      # ä¸åˆ›å»ºè‰ç¨¿
          prerelease: false # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            ${{ (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')) && 'windows-builds/*' || '' }}
            ${{ (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')) && 'linux-builds/*' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤5ï¼šæ¸…ç†æ„å»ºäº§ç‰©
      # å‘å¸ƒå®Œæˆååˆ é™¤ä¸´æ—¶çš„æ„å»ºäº§ç‰©ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
      - name: æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
        if: |
          github.event_name == 'push' || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_release == 'true')
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            windows-builds
            linux-builds